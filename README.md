# Инженерный калькулятор 2.0

Мини-проект, реализованный на HTML/CSS/JavaScript. Он развивает учебный калькулятор из главы 5 и добавляет инженерные функции, историю вычислений, поддержку горячих клавиш и переключение темы.

## Возможности

- Базовые операции: сложение, вычитание, умножение, деление.
- Расширенные операции: возведение в степень `xʸ`, корень `√`, факториал `!`, проценты `%`, модуль `|x|`.
- Тригонометрия: `sin`, `cos`, `tan`, `asin`, `acos`, `atan`.
- Логарифмы: `ln`, `log(base, value)`.
- Константы: `π`, `e`.
- Скобки, приоритеты операций и комбинированные выражения.
- История вычислений с очисткой и повторным использованием результатов.
- Копирование результата в буфер обмена.
- Светлая и тёмная тема (с учётом системных настроек).
- Управление с клавиатуры и кнопками UI.
- Обработка ошибок: деление на ноль, неверный ввод, пустые выражения, некорректные аргументы функций.

## Структура проекта

```
├── index.html        # Разметка интерфейса (toolbar, калькулятор, история)
├── style.css         # Стили, темы, сетки, доступность
└── calculator.js     # Логика: парсер, вычисления, UI
```

### `index.html`

- Контейнер `.app` с панелью инструмента (переключатель темы, доступ к истории).
- Блок дисплея (`#expr`, `#result`) и кнопка копирования `#copyResult`.
- Сетка кнопок с `data-value`/`data-action`, включая инженерные функции.
- Боковая панель `#historyPanel` с заголовком, очисткой и списком истории.
- Скрипт `calculator.js` подключён с `defer`.

### `style.css`

- CSS‑переменные и переключение темы через `data-theme`.
- Сетки и адаптивность для клавиш и истории.
- Визуальные состояния для доступности и активных элементов.

### `calculator.js`

- Управление DOM и состоянием выражения/истории.
- Токенизация, алгоритм шунтующей станции (Shunting Yard), вычисление RPN.
- Поддержка модулей, функций, констант, префиксных, инфиксных и постфиксных операторов.
- Обработка событий UI, клавиатуры, копирования и темы.

## Основные функции и объекты

| Имя | Назначение | Параметры | Возвращает |
| --- | --- | --- | --- |
| `formatNumber(num)` | Нормализует вывод, удаляя артефакты плавающей точки. | `num: number` | `string` |
| `factorial(value)` | Вычисляет факториал с проверками диапазона. | `value: number` | `number` |
| `toPercentMarker(value)` | Создаёт маркер процента для контекстного расчёта. | `value: number` | `{type:'percent', value, fraction}` |
| `resolveValue(raw, context)` | Приводит стековые значения к числу с учётом процентов. | `raw: number|PercentMarker`, `context?: {operator,left}` | `number` |
| `normalizeAbsolute(expr)` | Превращает `|x|` в `abs(x)` и проверяет пары `|`. | `expr: string` | `string` |
| `matchFunction(expr, index)` | Распознаёт функции (sin, log и др.). | `expr: string`, `index: number` | `string|null` |
| `matchConstant(expr, index)` | Находит `π`, `pi`, `e`. | `expr: string`, `index: number` | `{symbol,value}|null` |
| `tokenize(expr)` | Разбивает выражение на токены. | `expr: string` | `Token[]` |
| `infixToRPN(infix)` | Реализует шунтующую станцию → RPN. | `infix: string` | `Token[]` |
| `evaluateRPN(tokens)` | Вычисляет RPN и поддерживает операторы/функции. | `tokens: Token[]` | `number` |
| `computeExpression(infix)` | Валидирует и вычисляет выражение пользователя. | `infix: string` | `number` |
| `insertValue(val)` | Обрабатывает ввод с автодополнением и валидацией. | `val: string` | `void` |
| `addToHistory(expr, result)` | Добавляет запись в историю. | `expr: string`, `result: string` | `void` |
| `renderHistory()` | Перерисовывает список истории. | — | `void` |
| `toggleHistoryPanel()` | Открывает/закрывает панель истории. | — | `void` |
| `copyResult()` | Копирует результат через Clipboard API. | — | `Promise<void>` |
| `applyTheme(theme)` | Применяет выбранную тему. | `theme: 'light'|'dark'` | `void` |
| `initTheme()` | Инициализирует тему и подписки. | — | `void` |
| `handleAction(action)` | Обрабатывает действия (`clear`, `equals`, и др.). | `action: string` | `void` |

`OPERATORS`, `FUNCTION_DEFINITIONS`, наборы префиксных/постфиксных операторов и история (`history`) структурируют конфигурацию приложения.

## Горячие клавиши

- `0`–`9`, `.` — ввод цифр и десятичной точки.
- `+`, `-`, `*`, `/`, `^` — операторы.
- `%`, `!`, `(`, `)` — специальные символы.
- `Enter` или `=` — вычисление выражения.
- `Backspace` — удаление последнего символа.
- `Escape` — очистка выражения.

## Обработка ошибок

- Деление на ноль (`OPERATORS['/']`).
- Недостаток аргументов функций/операторов.
- Некорректные символы и запятые вне функций.
- Несбалансированные скобки и пары `|...|`.
- Некорректные аргументы `ln`, `log`, `asin`, `acos`, `√`, `factorial`.
- Пустое выражение при вычислении.

Ошибки отображаются в поле результата, а подробности выводятся в консоль.

## Примеры выражений

| Ввод | Результат |
| --- | --- |
| `sin(π/2)` | `1` |
| `log(2, 32)` | `5` |
| `√(9) + 4^2` | `19` |
| `|−7| + 15%` | `8.05` |
| `5! / (3! * 2!)` | `10` |

## Тестирование

- Ручная проверка интерфейса, истории и копирования.
- Проверка граничных случаев: пустая строка, деление на ноль, неверные аргументы функций.
- Тестирование горячих клавиш и переключения темы (системные предпочтения + кнопка).

## Требования к окружению

Современный браузер с поддержкой ES6 и Clipboard API. Для запуска откройте `index.html`.

